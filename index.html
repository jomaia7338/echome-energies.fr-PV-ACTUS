<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#1C1C1C"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Echome Prospection PV ‚Äì R1/R2 (Recherche + G√©oloc)</title>
  <style>
    :root{--brand:#37C3AF;--brand-dark:#2ea898;--carbon:#1C1C1C;--bg:#f8fafc;--text:#0f172a;--muted:#64748b;--r:14px;--shadow:0 6px 18px rgba(16,24,40,.08)}
    html,body{height:100%;-webkit-text-size-adjust:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
    header{padding-top:env(safe-area-inset-top);background:var(--carbon);color:#fff}
    .container{max-width:720px;margin:0 auto;padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:16px 0}
    .muted{color:var(--muted);font-size:12px}
    .badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;font-size:12px}
    .btn{border-radius:12px;padding:10px 14px;border:1px solid #e2e8f0;background:#fff;font-size:14px}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:var(--brand-dark)}
    .file-label{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #e2e8f0;background:#f1f5f9;font-size:14px;cursor:pointer}
    .file-input{display:none}
    .tabs{display:flex;gap:8px;background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:6px;margin:16px 0;position:sticky;top:8px;z-index:10}
    .tab{flex:1;text-align:center;padding:10px 14px;border-radius:12px;font-weight:600;font-size:14px;border:1px solid transparent}
    .tab.active{background:var(--brand);color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:600px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-size:13px;display:block}
    input,select,textarea{width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1px solid #cbd5e1;font-size:16px;background:#fff}
    textarea{resize:vertical;min-height:90px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + env(safe-area-inset-bottom));background:#0f172a;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:var(--shadow)}
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:flex-end}
    .sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;max-height:85vh;overflow:auto;width:100%;padding:12px}
    .item{padding:10px;border:1px solid #e2e8f0;border-radius:12px;margin:8px 0}
    .searchbar{display:flex;gap:8px;margin-bottom:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <div class="container row">
    <div class="row" style="gap:12px">
      <!-- Place ton logo ici si tu veux en base64 ou <img src="logo.png"> -->
      <div>
        <div style="font-size:18px;font-weight:600">Echome Prospection PV</div>
        <div class="muted">R1 (prospection) & R2 (qualification) ‚Ä¢ iOS</div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="row">
      <div>
        <b>Base Excel</b>
        <div class="muted">Charger / Nouvelle ‚Ä¢ Enregistrer R1/R2 ‚Ä¢ T√©l√©charger (puis Remplacer dans Fichiers/OneDrive)</div>
      </div>
      <div class="row" style="gap:8px">
        <label class="file-label"><input id="fileInput" type="file" accept=".xlsx" class="file-input">Charger</label>
        <button id="btnNew" class="btn">Nouvelle</button>
        <button id="btnSave" class="btn btn-primary">T√©l√©charger XLSX</button>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div id="status" class="muted">Aucune base charg√©e.</div>
      <div id="rowsInfo" class="badge">R1:0 ‚Ä¢ R2:0</div>
    </div>
  </div>

  <div class="tabs">
    <button id="tabR1" class="tab active">R1 ‚Äì Prospection / Suivi</button>
    <button id="tabR2" class="tab">R2 ‚Äì Qualification technique</button>
  </div>

  <!-- R1 -->
  <form id="formR1" class="card">
    <div class="row" style="gap:8px;justify-content:flex-end;margin-bottom:6px">
      <button type="button" id="btnNewClient" class="btn">Nouveau client (R1)</button>
      <button type="button" id="btnFindR1" class="btn">Rechercher R1</button>
    </div>
    <div class="grid grid-2">
      <div><label>Date R1</label><input type="date" id="r1_date"></div>
      <div>
        <label>Prospect ID <span class="muted">(ex: P-20251030-1234)</span></label>
        <div class="row" style="gap:8px">
          <input type="text" id="r1_id" placeholder="P-aaaammjj-####">
          <button type="button" id="btnGenId" class="btn">G√©n√©rer</button>
        </div>
      </div>
      <div><label>Nom / Pr√©nom</label><input type="text" id="r1_nom"></div>
      <div><label>T√©l√©phone</label><input type="tel" id="r1_tel"></div>
      <div><label>E-mail</label><input type="text" id="r1_email"></div>
      <div><label>Intervenant interne</label><input type="text" id="r1_intervenant"></div>
      <div><label>Raison sociale</label><input type="text" id="r1_rs"></div>
    </div>

    <div class="grid grid-2" style="margin-top:8px">
      <div><label>Adresse</label><input type="text" id="r1_adresse" placeholder="N¬∞, Rue‚Ä¶"></div>
      <div><label>Code Postal</label><input type="text" id="r1_cp"></div>
      <div><label>Commune</label><input type="text" id="r1_commune"></div>
      <div>
        <label>üß≠ G√©olocalisation</label>
        <div class="row" style="gap:8px">
          <select id="geo_mode">
            <option value="commune">Commune</option>
            <option value="commune_cp">Commune + CP</option>
            <option value="full">Adresse compl√®te</option>
          </select>
          <button type="button" id="btnGeo" class="btn">üìç Localiser</button>
        </div>
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:8px">
      <div><label>Int√©r√™t</label><select id="r1_interet"><option value="">‚Äî</option><option>Faible</option><option>Moyen</option><option>Fort</option></select></div>
      <div><label>D√©lai projet</label><select id="r1_delai"><option value="">‚Äî</option><option>Imm√©diat</option><option>‚â§ 3 mois</option><option>3‚Äì6 mois</option><option>> 6 mois</option><option>√Ä d√©finir</option></select></div>
      <div><label>Relance ‚Äì Date</label><input type="date" id="r1_relance_date"></div>
      <div><label>Relance ‚Äì Statut</label><select id="r1_relance_statut"><option>√Ä faire</option><option>Fait</option><option>Report√©</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="r1_notes"></textarea></div>
    </div>

    <div style="text-align:right;margin-top:8px">
      <button type="button" id="btnSaveR1" class="btn btn-primary">Enregistrer R1 ‚Üí Excel</button>
    </div>
  </form>

  <!-- R2 -->
  <form id="formR2" class="card" style="display:none">
    <div class="row" style="gap:8px;justify-content:flex-end;margin-bottom:6px">
      <div class="searchbar" style="flex:1;min-width:240px">
        <input id="r2_search" type="text" placeholder="Rechercher Prospect ID / Nom / Tel / Commune">
        <button type="button" id="btnPickFromR1" class="btn">Reprendre depuis R1</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div><label>Date R2</label><input type="date" id="r2_date"></div>
      <div><label>Prospect ID (m√™me que R1)</label><input type="text" id="r2_id" placeholder="P-aaaammjj-####"></div>

      <div><label>Type toiture</label><input type="text" id="r2_toiture"></div>
      <div><label>Nb panneaux + implantation</label><input type="text" id="r2_pv_nb"></div>
      <div><label>Type de r√©seau</label><select id="r2_reseau"><option value="">‚Äî</option><option>Monophas√©</option><option>Triphas√©</option></select></div>
      <div><label>Longueur dispo (m)</label><input type="number" id="r2_L" inputmode="decimal"></div>
      <div><label>Largeur dispo (m)</label><input type="number" id="r2_l" inputmode="decimal"></div>
      <div><label>Pente toit (¬∞)</label><input type="number" id="r2_pente" inputmode="decimal"></div>
      <div><label>Facture EDF demand√©e</label><select id="r2_facture_dem"><option>Non</option><option>Oui</option></select></div>

      <div><label>Type chauffage</label><input type="text" id="r2_chauff"></div>
      <div><label>Nb personnes</label><input type="number" id="r2_nbpers" inputmode="numeric"></div>
      <div><label>Profil pr√©sence</label><select id="r2_presence"><option value="">‚Äî</option><option>Toute la journ√©e</option><option>Matin midi soir</option><option>Matin et soir</option></select></div>
      <div><label>Surface habitable (m¬≤)</label><input type="number" id="r2_surface" inputmode="numeric"></div>
      <div><label>Niveau d'isolation</label><select id="r2_isolation"><option value="">‚Äî</option><option>Peu isol√©</option><option>Isol√©</option><option>Bien isol√©</option></select></div>
      <div><label>Type ECS</label><input type="text" id="r2_ecs"></div>
      <div><label>Climatisation</label><select id="r2_clim"><option>Non</option><option>Oui</option></select></div>
      <div><label>Piscine</label><select id="r2_piscine"><option>Non</option><option>Hors sol</option><option>Enterr√©e</option></select></div>

      <div><label>Pr√©sence VE</label><select id="r2_ve"><option value="">‚Äî</option><option>Non</option><option>Oui</option></select></div>
      <div><label>Mod√®le VE</label><input type="text" id="r2_ve_modele"></div>
      <div><label>Km annuels</label><input type="number" id="r2_km" inputmode="numeric"></div>
      <div><label>Recharges/sem domicile</label><input type="number" id="r2_rech_dom" inputmode="numeric"></div>
      <div><label>Recharges/sem bureau</label><input type="number" id="r2_rech_bureau" inputmode="numeric"></div>
      <div><label>Devis borne recharge</label><select id="r2_borne"><option value="">‚Äî</option><option>Non</option><option>Oui</option></select></div>

      <div style="grid-column:1/-1"><label>Notes compl√©mentaires</label><textarea id="r2_notes"></textarea></div>
    </div>

    <div style="text-align:right;margin-top:8px">
      <button type="button" id="btnSaveR2" class="btn btn-primary">Enregistrer R2 ‚Üí Excel</button>
    </div>
  </form>
</main>

<!-- Overlay Finder R1 -->
<div id="overlay" class="overlay">
  <div class="sheet">
    <div class="row" style="gap:8px">
      <div style="font-weight:600">Rechercher un prospect R1</div>
      <button id="btnCloseOverlay" class="btn">Fermer</button>
    </div>
    <div class="searchbar">
      <input id="q" type="text" placeholder="ID / Nom / Tel / Commune / CP / Email‚Ä¶" style="flex:1">
      <button id="btnSearch" class="btn">Chercher</button>
    </div>
    <div id="results"></div>
  </div>
</div>

<script>
/* Tabs */
const tabR1=document.getElementById('tabR1'),tabR2=document.getElementById('tabR2');
const formR1=document.getElementById('formR1'),formR2=document.getElementById('formR2');
tabR1.onclick=()=>{tabR1.classList.add('active');tabR2.classList.remove('active');formR1.style.display='block';formR2.style.display='none';};
tabR2.onclick=()=>{tabR2.classList.add('active');tabR1.classList.remove('active');formR2.style.display='block';formR1.style.display='none';};

/* Excel */
let wb=null;const SHEET_R1='R1_MOBILE',SHEET_R2='R2_MOBILE';
function statusMsg(m){document.getElementById('status').textContent=m;}
function setRowsInfo(){
  if(!wb){document.getElementById('rowsInfo').textContent='R1:0 ‚Ä¢ R2:0';return;}
  const r1=XLSX.utils.sheet_to_json(wb.Sheets[SHEET_R1]||{}, {header:1});
  const r2=XLSX.utils.sheet_to_json(wb.Sheets[SHEET_R2]||{}, {header:1});
  const n1=Math.max(0,(r1.length||0)-1),n2=Math.max(0,(r2.length||0)-1);
  document.getElementById('rowsInfo').textContent=`R1:${n1} ‚Ä¢ R2:${n2}`;
}
function newWB(){
  wb=XLSX.utils.book_new();
  const r1H=["Date R1","Prospect ID","Nom/Pr√©nom","T√©l√©phone","E-mail","Intervenant interne","Raison sociale","Adresse","CP","Commune","Int√©r√™t","D√©lai projet","Relance date","Relance statut","Notes"];
  const r2H=["Date R2","Prospect ID","Type toiture","Nb panneaux + implantation","Type r√©seau","Longueur (m)","Largeur (m)","Pente (¬∞)","Facture EDF demand√©e","Type chauffage","Nb personnes","Profil pr√©sence","Surface habitable (m¬≤)","Niveau d'isolation","Type ECS","Climatisation","Piscine","VE","VE mod√®le","Km annuels","Rech/sem domicile","Rech/sem bureau","Devis borne recharge","Notes"];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([r1H]),SHEET_R1);
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([r2H]),SHEET_R2);
  statusMsg("Nouvelle base pr√™te.");setRowsInfo();
}
function loadFile(file){
  const r=new FileReader();
  r.onload=e=>{const data=new Uint8Array(e.target.result);wb=XLSX.read(data,{type:'array'});statusMsg("Base charg√©e : "+file.name);setRowsInfo();};
  r.readAsArrayBuffer(file);
}
function downloadWB(){
  if(!wb) newWB();
  const blob=new Blob([XLSX.write(wb,{bookType:'xlsx',type:'array'})],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Prospection_PV.xlsx';a.click();URL.revokeObjectURL(url);
}
document.getElementById('fileInput').onchange=(e)=>{const f=e.target.files?.[0];if(f) loadFile(f);};
document.getElementById('btnNew').onclick=newWB;
document.getElementById('btnSave').onclick=downloadWB;

/* Helpers */
function todayISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
document.getElementById('r1_date').value=todayISO();document.getElementById('r2_date').value=todayISO();
document.getElementById('btnGenId').onclick=()=>{const d=new Date(),rnd=Math.floor(1000+Math.random()*9000);document.getElementById('r1_id').value=`P-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${rnd}`;};
document.getElementById('btnNewClient').onclick=()=>{ // clear R1 and generate new ID
  ['r1_nom','r1_tel','r1_email','r1_intervenant','r1_rs','r1_adresse','r1_cp','r1_commune','r1_notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('r1_interet').value='';document.getElementById('r1_delai').value='';document.getElementById('r1_relance_date').value='';document.getElementById('r1_relance_statut').value='√Ä faire';
  document.getElementById('r1_date').value=todayISO();document.getElementById('btnGenId').click();document.getElementById('r1_nom').focus();
};

/* Toast */
function toast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),1500);}

/* G√©oloc + reverse geocode (OSM) */
async function reverseGeocode(lat,lon){
  const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,{headers:{'Accept':'application/json'}});
  if(!res.ok) throw new Error('Geocoding error'); return res.json();
}
document.getElementById('btnGeo').onclick=()=>{
  const mode=document.getElementById('geo_mode').value;
  if(!navigator.geolocation){toast('G√©oloc non support√©e');return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const {latitude,longitude}=pos.coords;const data=await reverseGeocode(latitude,longitude);
      const a=data.address||{};
      const commune=a.city||a.town||a.village||a.municipality||'';
      const cp=a.postcode||'';
      const addrLine=[a.house_number,a.road,a.suburb,a.hamlet].filter(Boolean).join(' ');
      if(mode==='commune'){ r1_commune.value=commune; }
      else if(mode==='commune_cp'){ r1_commune.value=commune; r1_cp.value=cp; }
      else { r1_commune.value=commune; r1_cp.value=cp; r1_adresse.value=addrLine || (data.display_name||''); }
      toast('Position captur√©e');
    }catch(e){toast('√âchec g√©ocodage');}
  },()=>toast('G√©oloc refus√©e'));
};

/* Save R1 */
function req(obj,fields){const miss=fields.filter(f=>!obj[f]||String(obj[f]).trim()==='');if(miss.length){toast("Champs requis: "+miss.join(", "));return false;}return true;}
document.getElementById('btnSaveR1').onclick=()=>{
  if(!wb) newWB();
  const H=["Date R1","Prospect ID","Nom/Pr√©nom","T√©l√©phone","E-mail","Intervenant interne","Raison sociale","Adresse","CP","Commune","Int√©r√™t","D√©lai projet","Relance date","Relance statut","Notes"];
  const rec={"Date R1":r1_date.value||'',"Prospect ID":r1_id.value.trim(),"Nom/Pr√©nom":r1_nom.value.trim(),"T√©l√©phone":r1_tel.value.trim(),"E-mail":r1_email.value.trim(),"Intervenant interne":r1_intervenant.value.trim(),"Raison sociale":r1_rs.value.trim(),"Adresse":r1_adresse.value.trim(),"CP":r1_cp.value.trim(),"Commune":r1_commune.value.trim(),"Int√©r√™t":r1_interet.value,"D√©lai projet":r1_delai.value,"Relance date":r1_relance_date.value||'',"Relance statut":r1_relance_statut.value,"Notes":r1_notes.value.trim()};
  if(!req(rec,["Prospect ID","Nom/Pr√©nom","T√©l√©phone"])) return;
  const ws=wb.Sheets[SHEET_R1];const data=XLSX.utils.sheet_to_json(ws,{header:1});if(data.length===0) data.push(H);
  data.push(H.map(k=>rec[k]??''));wb.Sheets[SHEET_R1]=XLSX.utils.aoa_to_sheet(data);setRowsInfo();toast("R1 enregistr√©");
};

/* Save R2 */
document.getElementById('btnSaveR2').onclick=()=>{
  if(!wb) newWB();
  const H=["Date R2","Prospect ID","Type toiture","Nb panneaux + implantation","Type r√©seau","Longueur (m)","Largeur (m)","Pente (¬∞)","Facture EDF demand√©e","Type chauffage","Nb personnes","Profil pr√©sence","Surface habitable (m¬≤)","Niveau d'isolation","Type ECS","Climatisation","Piscine","VE","VE mod√®le","Km annuels","Rech/sem domicile","Rech/sem bureau","Devis borne recharge","Notes"];
  const rec={"Date R2":r2_date.value||'',"Prospect ID":r2_id.value.trim(),"Type toiture":r2_toiture.value.trim(),"Nb panneaux + implantation":r2_pv_nb.value.trim(),"Type r√©seau":r2_reseau.value,"Longueur (m)":r2_L.value||'',"Largeur (m)":r2_l.value||'',"Pente (¬∞)":r2_pente.value||'',"Facture EDF demand√©e":r2_facture_dem.value,"Type chauffage":r2_chauff.value.trim(),"Nb personnes":r2_nbpers.value||'',"Profil pr√©sence":r2_presence.value,"Surface habitable (m¬≤)":r2_surface.value||'',"Niveau d'isolation":r2_isolation.value,"Type ECS":r2_ecs.value.trim(),"Climatisation":r2_clim.value,"Piscine":r2_piscine.value,"VE":r2_ve.value,"VE mod√®le":r2_ve_modele.value.trim(),"Km annuels":r2_km.value||'',"Rech/sem domicile":r2_rech_dom.value||'',"Rech/sem bureau":r2_rech_bureau.value||'',"Devis borne recharge":r2_borne.value,"Notes":r2_notes.value.trim()};
  if(!req(rec,["Prospect ID"])) return;
  const ws=wb.Sheets[SHEET_R2];const data=XLSX.utils.sheet_to_json(ws,{header:1});if(data.length===0) data.push(H);
  data.push(H.map(k=>rec[k]??''));wb.Sheets[SHEET_R2]=XLSX.utils.aoa_to_sheet(data);setRowsInfo();toast("R2 enregistr√©");
};

/* Overlay Finder (R1) */
const overlay=document.getElementById('overlay'),resultsEl=document.getElementById('results');
document.getElementById('btnFindR1').onclick=()=>{if(!wb) newWB();overlay.style.display='flex';resultsEl.innerHTML='';document.getElementById('q').value='';};
document.getElementById('btnCloseOverlay').onclick=()=>overlay.style.display='none';
document.getElementById('btnSearch').onclick=()=>searchR1();
document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();searchR1();}});

function getR1Objects(){
  if(!wb) return [];
  const ws=wb.Sheets[SHEET_R1]; if(!ws) return [];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1}); if(!rows.length) return [];
  const headers=rows[0]; return rows.slice(1).map(r=>{const o={}; headers.forEach((h,i)=>o[h]=r[i]??''); return o;});
}
function escHtml(s){return (s||'').toString().replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));}
function searchR1(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const rows=getR1Objects();
  const list=rows.filter(o=>{
    const hay=[o["Prospect ID"],o["Nom/Pr√©nom"],o["T√©l√©phone"],o["E-mail"],o["Commune"],o["CP"]].map(x=>(x||'').toString().toLowerCase()).join(' | ');
    return !q || hay.includes(q);
  });
  if(!list.length){resultsEl.innerHTML='<div class="muted">Aucun r√©sultat</div>';return;}
  resultsEl.innerHTML=list.slice(0,200).map(o=>{
    const payload=btoa(unescape(encodeURIComponent(JSON.stringify(o))));
    return `
      <div class="item">
        <div style="font-weight:600">${escHtml(o["Nom/Pr√©nom"])||"(Sans nom)"} <span class="muted">(${escHtml(o["Prospect ID"])||"-"})</span></div>
        <div class="muted">${escHtml(o["T√©l√©phone"]||"")} ‚Ä¢ ${escHtml(o["E-mail"]||"")}</div>
        <div class="muted">${escHtml(o["Adresse"]||"")} ‚Ä¢ ${escHtml(o["CP"]||"")} ${escHtml(o["Commune"]||"")}</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick='copyToR1_b64("${payload}")'>Charger en R1</button>
          <button class="btn btn-primary" onclick='prefillR2_b64("${payload}")'>Pr√©-remplir R2</button>
        </div>
      </div>
    `;
  }).join('');
}
function decode_b64_json(b64){try{return JSON.parse(decodeURIComponent(escape(atob(b64))));}catch(e){return null;}}
function copyToR1_b64(b64){const o=decode_b64_json(b64); if(!o) return; copyToR1(o);}
function prefillR2_b64(b64){const o=decode_b64_json(b64); if(!o) return; prefillR2(o);}
function copyToR1(o){
  r1_date.value=o["Date R1"]||todayISO();
  r1_id.value=o["Prospect ID"]||'';
  r1_nom.value=o["Nom/Pr√©nom"]||'';
  r1_tel.value=o["T√©l√©phone"]||'';
  r1_email.value=o["E-mail"]||'';
  r1_intervenant.value=o["Intervenant interne"]||'';
  r1_rs.value=o["Raison sociale"]||'';
  r1_adresse.value=o["Adresse"]||'';
  r1_cp.value=o["CP"]||'';
  r1_commune.value=o["Commune"]||'';
  r1_interet.value=o["Int√©r√™t"]||'';
  r1_delai.value=o["D√©lai projet"]||'';
  r1_relance_date.value=o["Relance date"]||'';
  r1_relance_statut.value=o["Relance statut"]||'√Ä faire';
  r1_notes.value=o["Notes"]||'';
  overlay.style.display='none';
  toast('Fiche R1 charg√©e');
}
function prefillR2(o){
  tabR2.click();
  r2_id.value=o["Prospect ID"]||'';
  const ident=`[Identit√©] ${o["Nom/Pr√©nom"]||''} ‚Ä¢ ${o["T√©l√©phone"]||''} ‚Ä¢ ${o["E-mail"]||''}`;
  if(!r2_notes.value.includes(ident)) r2_notes.value=(r2_notes.value? r2_notes.value+'\\n' : '')+ident;
  toast('Prospect R1 repris en R2');
}

/* R2 quick pick */
document.getElementById('btnPickFromR1').onclick=()=>{
  const q=document.getElementById('r2_search').value.trim().toLowerCase();
  overlay.style.display='flex';document.getElementById('q').value=q;searchR1();
};
</script>
</body>
</html>