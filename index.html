<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#1C1C1C">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Echome Prospection PV ‚Äî v2 Offline Enrichie</title>
<link rel="icon" href="data:,">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --brand:#37C3AF; --brand-dark:#2ea898; --carbon:#1C1C1C;
  --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b;
  --r:14px; --shadow:0 6px 18px rgba(16,24,40,.08);
  --safe-top: env(safe-area-inset-top, 0px); --safe-bot: env(safe-area-inset-bottom, 0px);
}
@supports(padding: constant(safe-area-inset-top)) {
  :root{ --safe-top: constant(safe-area-inset-top); --safe-bot: constant(safe-area-inset-bottom); }
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
header{position:fixed;inset:0 0 auto 0;z-index:60;background:var(--carbon);color:#fff;padding-top:calc(var(--safe-top) + 4px);box-shadow:0 2px 12px rgba(0,0,0,.15)}
.header-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between;padding:8px 16px 10px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:32px;height:32px;object-fit:contain;border-radius:8px;background:#000}
.brand .t .title{font-weight:800;font-size:16px}
.brand .t .sub{font-size:12px;opacity:.8}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.actions .btn{background:#202324;border:1px solid #2f3336;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.actions .btn.primary{background:var(--brand);border-color:var(--brand);color:#0b1220}
main{padding-top:calc(64px + var(--safe-top)); padding-bottom:calc(16px + var(--safe-bot))}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:16px 0}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.input{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;font-size:16px}
select.input{padding-right:28px} textarea.input{min-height:90px;resize:vertical}
.btn{border-radius:12px;padding:10px 14px;border:1px solid #e2e8f0;background:#fff;font-size:14px;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)} .btn.primary:hover{background:var(--brand-dark)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
.tag{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px;font-size:12px}
.badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;font-size:12px}
.muted{color:var(--muted);font-size:12px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + var(--safe-bot));background:#0f172a;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:var(--shadow);z-index:999}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:1px solid #e2e8f0;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.tab.active{background:var(--brand);color:#0b1220;border-color:var(--brand)}
.list{display:grid;grid-template-columns:1fr;gap:10px}
.item{display:flex;gap:10px;align-items:center;padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
.item .avatar{width:40px;height:40px;border-radius:10px;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-weight:700}
.item .meta{flex:1;min-width:0}
.item .meta .name{font-weight:700}
.item .meta .line{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.float-add{position:fixed;right:16px;bottom:calc(16px + var(--safe-bot));z-index:55;background:var(--brand);color:#fff;border:none;border-radius:999px;width:56px;height:56px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 10px 20px rgba(55,195,175,.35)}
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.6);display:none;align-items:flex-end;z-index:70}
.sheet{background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;max-height:85vh;overflow:auto;width:100%;padding:12px}
.section-title{font-weight:800;margin:6px 0 8px}
.hidden{display:none}
hr{border:none;border-top:1px solid #e2e8f0;margin:12px 0}
/* Synth√®se */
.kpis{display:flex;gap:8px;flex-wrap:wrap}
.kpi{background:#f8fffd;border:1px solid #c7f4ea;border-radius:10px;padding:6px 10px;font-size:12px}
.kpi.warn{background:#fff7ed;border-color:#fed7aa}
/* Map modal */
#mapWrap{position:fixed;inset:0;display:none;z-index:80;background:#0b1220cc}
#mapPanel{position:absolute;left:0;right:0;bottom:0;top:0;margin:0}
#map{height:100%;width:100%}
.mapbar{position:absolute;left:0;right:0;top:0;display:flex;gap:8px;padding:8px;background:rgba(28,28,28,.85);color:#fff;align-items:center}
.mapbar .btn{background:#202324;border:1px solid #2f3336;color:#fff}
.mapbar .btn.primary{background:var(--brand);border-color:var(--brand);color:#0b1220}
/* Photos CR */
.thumb{width:64px;height:64px;border-radius:10px;border:1px solid #e2e8f0;object-fit:cover}
.gallery{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <img src="logo-echome-energies.png" alt="Echome">
      <div class="t">
        <div class="title">Echome Prospection PV</div>
        <div class="sub">v2 Offline ¬∑ R1+R2 ¬∑ Relances ¬∑ Export XLSX</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnImport">Importer</button>
      <input id="fileInput" type="file" accept=".xlsx,.csv" style="display:none">
      <button class="btn" id="btnExport">Exporter (XLSX)</button>
      <button class="btn primary" id="btnAddTop">+ Ajouter</button>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <!-- Tabs segments + filtres -->
    <div class="card">
      <div class="tabs" id="tabs">
        <div class="tab active" data-seg="">Tous</div>
        <div class="tab" data-seg="ACC_Vercors">ACC Vercors</div>
        <div class="tab" data-seg="ACC_SaintQuentin">ACC Saint-Quentin</div>
        <div class="tab" data-seg="PV_Residentiel">PV R√©sidentiel</div>
        <div class="tab" data-seg="PV_Professionnel">PV Pro</div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <input id="q" class="input" placeholder="Rechercher : Nom, Tel, Email, Commune, ID‚Ä¶" style="flex:1;min-width:220px">
        <select id="fPipeline" class="input" style="width:210px">
          <option value="">Pipeline : Tous</option>
          <option>Nouveau</option><option>√Ä qualifier</option><option>Contact √©tabli</option>
          <option>√âtude solaire demand√©e</option><option>Visite technique</option><option>Devis envoy√©</option>
          <option>N√©gociation</option><option>Accord client</option><option>Dossier OA/ENEDIS</option>
          <option>Chantier planifi√©</option><option>Install√©</option><option>Mis en service</option><option>Perdu</option>
          <option>ACC ‚Äì Rep√©rage</option><option>ACC ‚Äì Mobilisation</option><option>ACC ‚Äì R√©union copro/ASL</option>
          <option>ACC ‚Äì √âtude de potentiel</option><option>ACC ‚Äì Convention ACC</option>
          <option>ACC ‚Äì Contrats/Raccordement</option><option>ACC ‚Äì Mise en service</option>
        </select>
        <select id="fCanal" class="input" style="width:180px">
          <option value="">Canal : Tous</option>
          <option>Terrain</option><option>Inbound</option><option>R√©f√©rencement</option>
          <option>Parrainage</option><option>Partenaire</option><option>√âv√©nement</option>
        </select>
        <button class="btn" id="fRelanceToday">√Ä relancer (aujourd‚Äôhui)</button>
        <button class="btn" id="btnModeVisite">Mode Visite</button>
        <button class="btn" id="btnModeTechnique">Mode Technique</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="badge" id="statCount">0 prospect</span>
        <span class="tag">Aujourd‚Äôhui : <span id="statToday">0</span></span>
      </div>
    </div>

    <!-- Liste -->
    <div class="card">
      <div class="section-title">Prospects</div>
      <div id="list" class="list"></div>
      <button class="float-add" id="btnAdd">Ôºã</button>
    </div>
  </div>
</main>

<!-- Overlay FICHE -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <div class="section-title" id="sheetTitle">Fiche prospect</div>
      <div class="row">
        <button class="btn" id="btnCloseSheet">Fermer</button>
      </div>
    </div>

    <!-- Synth√®se -->
    <div id="synth" class="card" style="margin-top:0">
      <div class="kpis" id="synthKpis"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <a id="aCall" class="btn">üìû Appeler</a>
        <a id="aMail" class="btn">‚úâÔ∏è Email</a>
        <a id="aMaps" class="btn">üó∫Ô∏è Maps</a>
        <button id="btnEdit" class="btn primary">‚úèÔ∏è Modifier</button>
        <button id="btnFollow" class="btn">‚è∞ Suivre (J+7)</button>
      </div>
    </div>

    <div id="view-read" class="card">
      <div id="readContent"></div>
    </div>

    <div id="view-edit" class="card hidden">
      <div class="row" style="gap:8px;margin-bottom:8px">
        <button id="btnSubmit" class="btn primary">Soumettre</button>
        <button id="btnCancel" class="btn">Annuler</button>
        <button id="btnLocate" class="btn">üìç Localiser & remplir</button>
        <button id="btnMap" class="btn">üó∫Ô∏è Carte</button>
      </div>
      <form id="form">
        <!-- En-t√™te -->
        <div class="row" style="gap:12px">
          <div style="flex:1 1 220px"><label>ID Prospect</label><input id="f_id" class="input" placeholder="P-aaaammjj-####"></div>
          <div style="flex:1 1 180px"><label>Date</label><input id="f_date" class="input" type="date"></div>
          <div style="flex:1 1 220px"><label>Segment</label>
            <select id="f_segment" class="input">
              <option>ACC_Vercors</option><option>ACC_SaintQuentin</option><option>PV_Residentiel</option><option>PV_Professionnel</option>
            </select>
          </div>
          <div style="flex:1 1 200px"><label>March√©</label>
            <select id="f_marche" class="input"><option>PV Individuel</option><option>PV Tertiaire</option><option>ACC (Collectif)</option></select>
          </div>
        </div>
        <hr>
        <!-- Coordonn√©es -->
        <div class="row" style="gap:12px">
          <div style="flex:1 1 260px"><label>Nom / Pr√©nom (ou soci√©t√©)</label><input id="f_nom" class="input"></div>
          <div style="flex:1 1 200px"><label>T√©l√©phone</label><input id="f_tel" class="input" inputmode="tel"></div>
          <div style="flex:1 1 240px"><label>E-mail</label><input id="f_email" class="input"></div>
        </div>
        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1 1 260px"><label>Adresse</label><input id="f_adresse" class="input" placeholder="N¬∞, Rue‚Ä¶"></div>
          <div style="flex:1 1 120px"><label>CP</label><input id="f_cp" class="input"></div>
          <div style="flex:1 1 200px"><label>Commune</label><input id="f_commune" class="input"></div>
          <div style="flex:1 1 140px"><label>Lat</label><input id="f_lat" class="input" inputmode="decimal" placeholder="auto"></div>
          <div style="flex:1 1 140px"><label>Lon</label><input id="f_lon" class="input" inputmode="decimal" placeholder="auto"></div>
        </div>
        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1 1 200px"><label>Canal</label>
            <select id="f_canal" class="input"><option>Terrain</option><option>Inbound</option><option>R√©f√©rencement</option><option>Parrainage</option><option>Partenaire</option><option>√âv√©nement</option></select>
          </div>
          <div style="flex:1 1 260px"><label>Pipeline</label><select id="f_pipeline" class="input"></select></div>
          <div style="flex:1 1 200px"><label>Relance ‚Äì Date</label><input id="f_relance_date" class="input" type="date"></div>
          <div style="flex:1 1 200px"><label>Relance ‚Äì Statut</label>
            <select id="f_relance_statut" class="input"><option>√Ä faire</option><option>Fait</option><option>Report√©</option><option>Ne pas relancer</option><option>RDV planifi√©</option></select>
          </div>
        </div>

        <!-- ACC conditionnel -->
        <div id="accBlock" class="card" style="display:none; margin-top:12px">
          <div class="section-title">Infos ACC</div>
          <div class="row" style="gap:12px">
            <div style="flex:1 1 220px"><label>Type collectif</label>
              <select id="f_acc_type" class="input"><option>Copropri√©t√©</option><option>Lotissement</option><option>Parc social</option><option>Autre</option></select>
            </div>
            <div style="flex:1 1 140px"><label>Nb logements</label><input id="f_acc_logts" class="input" inputmode="numeric"></div>
            <div style="flex:1 1 200px"><label>Conso annuelle (MWh)</label><input id="f_acc_conso" class="input" inputmode="decimal"></div>
            <div style="flex:1 1 200px"><label>Surface toiture (m¬≤)</label><input id="f_acc_toit" class="input" inputmode="decimal"></div>
          </div>
          <div class="row" style="gap:12px;margin-top:8px">
            <div style="flex:1 1 260px"><label>Contact syndic/gestionnaire</label><input id="f_acc_contact" class="input"></div>
            <div style="flex:1 1 160px"><label>PMO</label><select id="f_acc_pmo" class="input"><option>Non</option><option>Oui</option></select></div>
          </div>
        </div>

        <!-- R2 -->
        <div class="card" style="margin-top:12px">
          <div class="section-title">R2 ‚Äî Qualification technique</div>
          <div class="row" style="gap:12px">
            <div style="flex:1 1 220px"><label>Type de toiture</label>
              <select id="f_r2_toiture" class="input">
                <option>Tuiles m√©caniques</option><option>Tuiles canal</option><option>Ardoise</option><option>Bac acier</option><option>Fibrociment</option><option>Plate/ETANCHE</option>
              </select>
            </div>
            <div style="flex:1 1 200px"><label>R√©seau</label><select id="f_r2_reseau" class="input"><option>Monophas√©</option><option>Triphas√©</option></select></div>
            <div style="flex:1 1 260px"><label>N¬∞ PDL</label><input id="f_r2_pdl" class="input" placeholder="14 chiffres"></div>
          </div>
          <div class="row" style="gap:12px;margin-top:8px">
            <div style="flex:1 1 220px"><label>ECS</label><select id="f_r2_ecs" class="input"><option>√âlectrique</option><option>Gaz</option><option>PAC</option><option>Autre</option></select></div>
            <div style="flex:1 1 240px"><label>V√©hicule √âlectrique (mod√®le)</label><input id="f_r2_ve_modele" class="input" placeholder="Citadine / Berline / SUV"></div>
            <div style="flex:1 1 160px"><label>Km/an VE</label><input id="f_r2_ve_km" class="input" inputmode="numeric"></div>
            <div style="flex:1 1 240px"><label>Recharges/semaine (domicile/bureau)</label><input id="f_r2_ve_recharges" class="input" placeholder="ex. 3 domicile / 1 bureau"></div>
          </div>
        </div>

        <!-- Compte rendu -->
        <div class="card" style="margin-top:12px">
          <div class="section-title">Compte rendu de visite</div>
          <div class="row" style="gap:12px">
            <div style="flex:1 1 200px"><label>Date visite</label><input id="f_cr_date" type="date" class="input"></div>
            <div style="flex:1 1 160px"><label>Dur√©e (min)</label><input id="f_cr_duree" class="input" inputmode="numeric" placeholder="ex. 45"></div>
            <div style="flex:1 1 220px"><label>Next step</label>
              <select id="f_cr_next" class="input"><option>Relance</option><option>Envoyer doc</option><option>Devis</option><option>Visite technique</option><option>Attente</option></select>
            </div>
          </div>
          <div style="margin-top:8px"><label>Commentaires</label><textarea id="f_cr_notes" class="input" placeholder="R√©sum√©, objections, timing‚Ä¶"></textarea></div>
          <div style="margin-top:8px" class="row">
            <label class="btn">üì∑ Joindre photo(s) <input id="f_cr_photos" type="file" accept="image/*" multiple style="display:none"></label>
          </div>
          <div id="crGallery" class="gallery"></div>
        </div>

        <div style="margin-top:8px"><label>Notes g√©n√©rales</label><textarea id="f_notes" class="input"></textarea></div>
      </form>
    </div>
  </div>
</div>

<!-- Map full-screen -->
<div id="mapWrap">
  <div id="mapPanel">
    <div class="mapbar">
      <button class="btn" id="mapClose">Fermer</button>
      <button class="btn" id="mapLocate">Me localiser</button>
      <div class="row" style="margin-left:auto;gap:8px">
        <button class="btn primary" id="mapUse">Utiliser cette adresse</button>
      </div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script>
// ====== Store local ======
const KEY = 'echome_prospects_v20';
let DB = load();
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
function save(){ localStorage.setItem(KEY, JSON.stringify(DB)); }

// ====== Utils ======
const $ = id => document.getElementById(id);
function toast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),1600);}
function todayISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function addDays(dateISO, days){const d=new Date(dateISO||todayISO()); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10);}
function genId(){const d=new Date(),r=Math.floor(1000+Math.random()*9000);return `P-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${r}`;}
function telLink(t){return t?`tel:${t.replace(/\s+/g,'')}`:'#';}
function mailLink(m,sub='Prospect Echome'){return m?`mailto:${encodeURIComponent(m)}?subject=${encodeURIComponent(sub)}`:'#';}
function mapsLink(addr,lat,lon){ if(lat && lon) return `https://maps.apple.com/?ll=${lat},${lon}`; const q=[addr].filter(Boolean).join(' ');return `https://maps.apple.com/?q=${encodeURIComponent(q)}`;}
function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

// ====== Pipelines ======
const PIPE_PV = ["Nouveau","√Ä qualifier","Contact √©tabli","√âtude solaire demand√©e","Visite technique","Devis envoy√©","N√©gociation","Accord client","Dossier OA/ENEDIS","Chantier planifi√©","Install√©","Mis en service","Perdu"];
const PIPE_ACC = ["ACC ‚Äì Rep√©rage","ACC ‚Äì Mobilisation","ACC ‚Äì R√©union copro/ASL","ACC ‚Äì √âtude de potentiel","ACC ‚Äì Convention ACC","ACC ‚Äì Contrats/Raccordement","ACC ‚Äì Mise en service","Perdu"];
function fillPipelineOptions(selectEl, marche){ const opts = (marche==="ACC (Collectif)") ? PIPE_ACC : PIPE_PV; selectEl.innerHTML = opts.map(o=>`<option>${o}</option>`).join(''); }

// ====== UI : List & Filters ======
const listEl = $('list'); const qEl = $('q'); const fPipe = $('fPipeline'); const fCanal = $('fCanal'); const tabsEl = $('tabs');
let filterRelanceToday=false; let filterSegment="";
$('fRelanceToday').onclick=()=>{ filterRelanceToday=!filterRelanceToday; renderList(); };
tabsEl.querySelectorAll('.tab').forEach(tab=>tab.onclick=()=>{ tabsEl.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); filterSegment = tab.dataset.seg||""; renderList(); });

$('btnModeVisite').onclick=()=>{ document.body.dataset.mode='visite'; toast('Mode Visite : R1 + CR'); };
$('btnModeTechnique').onclick=()=>{ document.body.dataset.mode='technique'; toast('Mode Technique : R2'); };

function renderList(){
  const q=(qEl.value||'').toLowerCase(); const pipe=fPipe.value||''; const canal=fCanal.value||'';
  const rows = DB.filter(p=>{
    if(filterSegment && p.segment!==filterSegment) return false;
    if(pipe && p.pipeline!==pipe) return false;
    if(canal && p.canal!==canal) return false;
    if(filterRelanceToday && p.relance_date!==todayISO()) return false;
    if(!q) return true;
    const hay=[p.id,p.nom,p.tel,p.email,p.commune,p.segment].join(' ').toLowerCase();
    return hay.includes(q);
  }).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  $('statCount').textContent = `${rows.length} prospect${rows.length>1?'s':''}`;
  const today=todayISO(); $('statToday').textContent = rows.filter(p=>p.date===today).length;
  if(!rows.length){ listEl.innerHTML = `<div class="muted">Aucun prospect. Utilise ‚Äú+ Ajouter‚Äù.</div>`; return; }
  listEl.innerHTML = rows.map(p=>`
    <div class="item" onclick='openRead("${p.id}")'>
      <div class="avatar">${(p.nom||'?').trim().slice(0,2).toUpperCase()}</div>
      <div class="meta">
        <div class="name">${escapeHtml(p.nom||'(Sans nom)')} <span class="muted">‚Ä¢ ${escapeHtml(p.segment||'')}</span> <span class="muted">‚Ä¢ ${p.id||''}</span></div>
        <div class="line">${escapeHtml(p.commune||'')} ${p.cp?('('+p.cp+')'):''} ‚Ä¢ ${escapeHtml(p.tel||'')}</div>
        <div class="line">${escapeHtml(p.marche||'')} ¬∑ ${escapeHtml(p.pipeline||'N/A')} ¬∑ ${escapeHtml(p.canal||'')}</div>
      </div>
    </div>
  `).join('');
}
[qEl,fPipe,fCanal].forEach(el=>el.addEventListener('input',renderList));

// ====== Overlay & Fiche ======
const overlay = $('overlay'); const readView = $('view-read'); const editView = $('view-edit'); const readContent = $('readContent'); const sheetTitle = $('sheetTitle'); const synthKpis = $('synthKpis');
$('btnCloseSheet').onclick=()=>overlay.style.display='none';

function completeness(p){
  const r1ok = !!(p.nom && p.tel && (p.adresse||p.commune));
  const r2ok = !!(p.r2_pdl && p.r2_toiture && p.r2_reseau);
  return {r1ok, r2ok};
}
function openRead(id){
  const p = DB.find(x=>x.id===id); if(!p) return;
  sheetTitle.textContent = "Fiche prospect";
  readView.classList.remove('hidden'); editView.classList.add('hidden');

  const {r1ok,r2ok} = completeness(p);
  const acc = (p.marche==="ACC (Collectif)");
  synthKpis.innerHTML = `
    <div class="kpi">Segment : <strong>${escapeHtml(p.segment||'')}</strong></div>
    <div class="kpi">Pipeline : <strong>${escapeHtml(p.pipeline||'N/A')}</strong></div>
    <div class="kpi ${r1ok?'':'warn'}">R1 : ${r1ok?'‚úÖ complet':'‚è≥ incomplet'}</div>
    <div class="kpi ${r2ok?'':'warn'}">R2 : ${r2ok?'‚úÖ complet':'‚è≥ incomplet'}</div>
    ${p.relance_date?`<div class="kpi">Relance : ${escapeHtml(p.relance_date)} (${escapeHtml(p.relance_statut||'√Ä faire')})</div>`:''}
    ${acc?`<div class="kpi">ACC</div>`:''}
  `;
  readContent.innerHTML = `
    <div class="row" style="gap:16px;flex-wrap:wrap">
      <div><strong>${escapeHtml(p.nom||'(Sans nom)')}</strong></div>
      <div class="muted">${escapeHtml(p.email||'')} ‚Ä¢ ${escapeHtml(p.tel||'')}</div>
      <div class="muted">${escapeHtml(p.adresse||'')} ${p.cp||''} ${escapeHtml(p.commune||'')}</div>
    </div>
    <hr>
    ${acc?`
      <div><strong>Infos ACC</strong></div>
      <div class="muted">Type: ${escapeHtml(p.acc_type||'')} ‚Ä¢ Logts: ${escapeHtml(p.acc_logts||'')}</div>
      <div class="muted">Conso: ${escapeHtml(p.acc_conso||'')} MWh ‚Ä¢ Toiture: ${escapeHtml(p.acc_toit||'')} m¬≤ ‚Ä¢ PMO: ${escapeHtml(p.acc_pmo||'')}</div>
      <div class="muted">Contact gestionnaire: ${escapeHtml(p.acc_contact||'')}</div>
      <hr>
    `:''}
    <div><strong>R2 ‚Äî Qualification</strong></div>
    <div class="muted">Toiture: ${escapeHtml(p.r2_toiture||'')} ‚Ä¢ R√©seau: ${escapeHtml(p.r2_reseau||'')} ‚Ä¢ PDL: ${escapeHtml(p.r2_pdl||'')}</div>
    <div class="muted">ECS: ${escapeHtml(p.r2_ecs||'')} ‚Ä¢ VE: ${escapeHtml(p.r2_ve_modele||'')} (${escapeHtml(p.r2_ve_km||'')} km/an; ${escapeHtml(p.r2_ve_recharges||' recharges/sem')})</div>
    <hr>
    <div><strong>Compte rendu</strong></div>
    <div class="muted">Date: ${escapeHtml(p.cr_date||'')} ‚Ä¢ Dur√©e: ${escapeHtml(p.cr_duree||'')} min ‚Ä¢ Next: ${escapeHtml(p.cr_next||'')}</div>
    ${p.cr_notes?`<p>${escapeHtml(p.cr_notes)}</p>`:''}
    ${renderGallery(p)}
    <hr>
    <div class="muted">ID: ${escapeHtml(p.id||'')} ‚Ä¢ Date fiche: ${escapeHtml(p.date||'')}</div>
    ${p.notes?`<p>${escapeHtml(p.notes)}</p>`:''}
  `;
  $('aCall').href = telLink(p.tel);
  $('aMail').href = mailLink(p.email, `Prospect ${p.id||''}`);
  $('aMaps').href = mapsLink(`${p.adresse||''} ${p.cp||''} ${p.commune||''}`, p.lat, p.lon);
  $('btnEdit').onclick=()=>openEdit(p);
  $('btnFollow').onclick=()=>{ p.relance_date = addDays(todayISO(),7); p.relance_statut='√Ä faire'; save(); toast('Relance planifi√©e J+7'); openRead(p.id); };

  overlay.style.display='flex';
}
function renderGallery(p){
  if(!p.cr_photos || !p.cr_photos.length) return '';
  const imgs = p.cr_photos.map(b64=>`<img class="thumb" src="${b64}">`).join('');
  return `<div class="gallery">${imgs}</div>`;
}

function openAdd(){ const p = { id: genId(), date: todayISO(), segment: filterSegment||'PV_Residentiel', marche:'PV Individuel', canal:'Terrain', relance_statut:'√Ä faire', pipeline: PIPE_PV[0] }; openEdit(p, true); }
$('btnAdd').onclick=openAdd; $('btnAddTop').onclick=openAdd;

// ====== √âdition ======
const f = {
  id:$('f_id'), date:$('f_date'), segment:$('f_segment'), marche:$('f_marche'),
  nom:$('f_nom'), tel:$('f_tel'), email:$('f_email'),
  adresse:$('f_adresse'), cp:$('f_cp'), commune:$('f_commune'),
  lat:$('f_lat'), lon:$('f_lon'), canal:$('f_canal'),
  pipeline:$('f_pipeline'), relance_date:$('f_relance_date'), relance_statut:$('f_relance_statut'),
  // ACC
  acc_type:$('f_acc_type'), acc_logts:$('f_acc_logts'), acc_conso:$('f_acc_conso'), acc_toit:$('f_acc_toit'),
  acc_contact:$('f_acc_contact'), acc_pmo:$('f_acc_pmo'),
  // R2
  r2_toiture:$('f_r2_toiture'), r2_reseau:$('f_r2_reseau'), r2_pdl:$('f_r2_pdl'),
  r2_ecs:$('f_r2_ecs'), r2_ve_modele:$('f_r2_ve_modele'), r2_ve_km:$('f_r2_ve_km'), r2_ve_recharges:$('f_r2_ve_recharges'),
  // CR
  cr_date:$('f_cr_date'), cr_duree:$('f_cr_duree'), cr_next:$('f_cr_next'), cr_notes:$('f_cr_notes'), cr_photos:$('f_cr_photos'),
  // Divers
  notes:$('f_notes')
}; let editIsNew=false;

function openEdit(p, isNew=false){
  editIsNew=isNew;
  $('sheetTitle').textContent = isNew ? "Nouveau prospect" : "Modifier le prospect";
  readView.classList.add('hidden'); editView.classList.remove('hidden'); overlay.style.display='flex';

  v(f.id,p.id); v(f.date,p.date||todayISO()); v(f.segment,p.segment||'PV_Residentiel');
  v(f.marche,p.marche||'PV Individuel'); fillPipelineOptions(f.pipeline, f.marche.value); v(f.pipeline, p.pipeline || f.pipeline.options[0]?.value || '');
  v(f.nom,p.nom); v(f.tel,p.tel); v(f.email,p.email);
  v(f.adresse,p.adresse); v(f.cp,p.cp); v(f.commune,p.commune);
  v(f.lat,p.lat); v(f.lon,p.lon); v(f.canal,p.canal||'Terrain');
  v(f.relance_date,p.relance_date); v(f.relance_statut,p.relance_statut||'√Ä faire');

  const isACC = (f.marche.value==="ACC (Collectif)");
  $('accBlock').style.display = isACC ? 'block' : 'none';
  v(f.acc_type,p.acc_type||'Copropri√©t√©'); v(f.acc_logts,p.acc_logts); v(f.acc_conso,p.acc_conso); v(f.acc_toit,p.acc_toit);
  v(f.acc_contact,p.acc_contact); v(f.acc_pmo,p.acc_pmo||'Non');

  v(f.r2_toiture,p.r2_toiture||'Tuiles m√©caniques'); v(f.r2_reseau,p.r2_reseau||'Monophas√©');
  v(f.r2_pdl,p.r2_pdl); v(f.r2_ecs,p.r2_ecs||'√âlectrique'); v(f.r2_ve_modele,p.r2_ve_modele);
  v(f.r2_ve_km,p.r2_ve_km); v(f.r2_ve_recharges,p.r2_ve_recharges);

  v(f.cr_date,p.cr_date||todayISO()); v(f.cr_duree,p.cr_duree); v(f.cr_next,p.cr_next||'Relance'); v(f.cr_notes,p.cr_notes);
  renderCRGallery(p.cr_photos||[]);

  f.marche.onchange = ()=>{
    fillPipelineOptions(f.pipeline, f.marche.value);
    f.pipeline.value = (f.marche.value==="ACC (Collectif)") ? PIPE_ACC[0] : PIPE_PV[0];
    $('accBlock').style.display = (f.marche.value==="ACC (Collectif)") ? 'block' : 'none';
  };
  $('btnSubmit').onclick=submitEdit; $('btnCancel').onclick=()=>openRead(f.id.value);
  $('btnLocate').onclick=locateAndFill; $('btnMap').onclick=initMapModal; f.cr_photos.onchange = handleCRPhotos;
}
function v(el,val){el.value = (val??'');}

async function locateAndFill(){
  if(!navigator.geolocation){ toast('G√©olocalisation indisponible'); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`, {headers:{'Accept':'application/json'}});
      const data = await r.json(); const a = data.address||{};
      const commune = a.city||a.town||a.village||a.municipality||''; const cp = a.postcode||'';
      const addr = [a.house_number,a.road,a.suburb,a.hamlet].filter(Boolean).join(' ');
      f.lat.value = String(lat.toFixed(6)); f.lon.value = String(lon.toFixed(6));
      f.adresse.value = addr || (data.display_name||''); f.cp.value = cp; f.commune.value = commune;
      toast('Adresse auto-remplie via g√©oloc');
    }catch(e){ toast('Reverse geocoding indisponible'); }
  }, ()=>toast('G√©oloc refus√©e'));
}

// ====== Carte ======
let map, marker;
const mapWrap = $('mapWrap');
$('mapClose').onclick=()=>mapWrap.style.display='none';
$('mapLocate').onclick=()=>navigator.geolocation?.getCurrentPosition(p=>{ map.setView([p.coords.latitude,p.coords.longitude], 17); marker.setLatLng([p.coords.latitude,p.coords.longitude]); }, ()=>toast('G√©oloc refus√©e'));
$('mapUse').onclick=async ()=>{
  const ll = marker.getLatLng();
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${ll.lat}&lon=${ll.lng}`,{headers:{'Accept':'application/json'}});
    const data = await res.json(); const a=data.address||{};
    const commune=a.city||a.town||a.village||a.municipality||''; const cp=a.postcode||'';
    const addr=[a.house_number,a.road,a.suburb,a.hamlet].filter(Boolean).join(' ');
    f.lat.value = String(ll.lat.toFixed(6)); f.lon.value = String(ll.lng.toFixed(6));
    f.adresse.value = addr || (data.display_name||''); f.cp.value = cp; f.commune.value = commune;
    mapWrap.style.display='none'; toast('Adresse renseign√©e depuis la carte');
  }catch(e){ toast('Reverse geocoding indisponible'); }
};
function initMapModal(){
  mapWrap.style.display='block';
  setTimeout(()=>{
    if(!map){
      map = L.map('map',{zoomControl:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
      marker = L.marker([45.1885,5.7245],{draggable:true}).addTo(map); // Grenoble d√©faut
      map.setView(marker.getLatLng(), 14);
      map.on('click', (e)=> marker.setLatLng(e.latlng));
    }
    const lat=parseFloat(f.lat.value), lon=parseFloat(f.lon.value);
    if(!isNaN(lat) && !isNaN(lon)){ map.setView([lat,lon], 17); marker.setLatLng([lat,lon]); }
    else if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude,p.coords.longitude], 17); marker.setLatLng([p.coords.latitude,p.coords.longitude]); }); }
    setTimeout(()=>map.invalidateSize(),120);
  },50);
}

// ====== CR : photos base64 ======
function handleCRPhotos(ev){
  const files = Array.from(ev.target.files||[]).slice(0,8);
  const readers = files.map(f=> new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f); }));
  Promise.all(readers).then(list=>{
    const cur = getCurrentPhotos();
    const all = cur.concat(list).slice(0,8);
    renderCRGallery(all);
  });
}
function getCurrentPhotos(){ return Array.from(document.querySelectorAll('#crGallery img')).map(img=>img.src); }
function renderCRGallery(arr){ $('crGallery').innerHTML = arr.map(src=>`<img class="thumb" src="${src}">`).join(''); }

// ====== Soumission & pipeline ======
function promotePipeline(p){
  const isACC = (p.marche === "ACC (Collectif)");
  const atLeast = isACC ? "ACC ‚Äì √âtude de potentiel" : "√âtude solaire demand√©e";
  if((p.r2_pdl||'').length >= 8){
    const order = (arr,val)=>arr.indexOf(val);
    const seq = isACC ? PIPE_ACC : PIPE_PV;
    if(order(seq,p.pipeline) < order(seq,atLeast)) p.pipeline = atLeast;
  }
}
function submitEdit(){
  const photos = getCurrentPhotos();
  const p = {
    id: f.id.value.trim()||genId(), date: f.date.value||todayISO(),
    segment: f.segment.value, marche: f.marche.value,
    nom: f.nom.value.trim(), tel: f.tel.value.trim(), email: f.email.value.trim(),
    adresse: f.adresse.value.trim(), cp: f.cp.value.trim(), commune: f.commune.value.trim(),
    lat: f.lat.value||'', lon: f.lon.value||'',
    canal: f.canal.value, pipeline: f.pipeline.value,
    relance_date: f.relance_date.value||'', relance_statut: f.relance_statut.value,
    // ACC
    acc_type: f.acc_type?.value||'', acc_logts: f.acc_logts?.value||'',
    acc_conso: f.acc_conso?.value||'', acc_toit: f.acc_toit?.value||'',
    acc_contact: f.acc_contact?.value?.trim()||'', acc_pmo: f.acc_pmo?.value||'',
    // R2
    r2_toiture: f.r2_toiture.value, r2_reseau: f.r2_reseau.value, r2_pdl: f.r2_pdl.value.trim(),
    r2_ecs: f.r2_ecs.value, r2_ve_modele: f.r2_ve_modele.value.trim(), r2_ve_km: f.r2_ve_km.value.trim(), r2_ve_recharges: f.r2_ve_recharges.value.trim(),
    // CR
    cr_date: f.cr_date.value||todayISO(), cr_duree: f.cr_duree.value.trim(), cr_next: f.cr_next.value, cr_notes: f.cr_notes.value.trim(), cr_photos: photos,
    // Divers
    notes: f.notes.value.trim()
  };
  if(!p.nom || !p.tel){ toast('Nom & T√©l√©phone requis'); return; }
  promotePipeline(p);
  const idx = DB.findIndex(x=>x.id===p.id);
  if(idx>=0) DB[idx]=p; else DB.push(p);
  save(); renderList(); toast(editIsNew?'Prospect ajout√©':'Prospect mis √† jour'); openRead(p.id);
}
$('btnSubmit').onclick=submitEdit;

// ====== Import / Export (XLSX compatible avec ton template) ======
$('btnImport').onclick=()=>$('fileInput').click();
$('fileInput').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    if(f.name.toLowerCase().endsWith('.csv')){
      importCSV(ev.target.result);
    }else{
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws); importRows(rows);
    }
  };
  if(f.name.toLowerCase().endsWith('.csv')) reader.readAsText(f); else reader.readAsArrayBuffer(f);
};

function importCSV(text){
  const lines = text.split(/\r?\n/).filter(x=>x.trim().length);
  const hdr = lines[0].split(',').map(x=>x.trim().replace(/^"|"$/g,''));
  const rows = lines.slice(1).map(l=>{
    const cols = l.split(',').map(x=>x.trim().replace(/^"|"$/g,''));
    const o={}; hdr.forEach((h,i)=>o[h]=cols[i]||''); return o;
  });
  importRows(rows);
}
function norm(o){
  // Supporte tes colonnes Excel (template) ET l‚Äôexport de l‚Äôapp
  return {
    id: o['Prospect_ID']||o['Prospect ID']||o['id']||o['ID']||genId(),
    date: o['Date_fiche']||o['Date']||o['date']||todayISO(),
    segment: o['Segment']||o['segment']||'PV_Residentiel',
    marche: o['Marche']||o['march√©']||o['marche']||'PV Individuel',
    nom: o['Nom']||o['nom']||'',
    tel: o['Telephone']||o['T√©l√©phone']||o['tel']||o['Phone']||'',
    email: o['Email']||o['E-mail']||o['email']||'',
    adresse: o['Adresse']||o['adresse']||'',
    cp: o['CP']||o['cp']||'',
    commune: o['Commune']||o['commune']||'',
    lat: o['Lat']||o['lat']||'',
    lon: o['Lon']||o['lon']||'',
    canal: o['Canal']||o['canal']||'Terrain',
    pipeline: o['Pipeline']||o['pipeline']||'Nouveau',
    relance_date: o['Relance_Date']||o['Relance date']||o['relance_date']||'',
    relance_statut: o['Relance_Statut']||o['Relance statut']||o['relance_statut']||'√Ä faire',
    // ACC
    acc_type: o['ACC_Type']||o['ACC Type']||o['acc_type']||'',
    acc_logts: o['ACC_Logts']||o['acc_logts']||'',
    acc_conso: o['ACC_Conso_MWh']||o['ACC Conso MWh']||o['acc_conso']||'',
    acc_toit: o['ACC_Toit_m2']||o['ACC Toit m2']||o['acc_toit']||'',
    acc_contact: o['ACC_Contact']||o['ACC Contact']||o['acc_contact']||'',
    acc_pmo: o['ACC_PMO']||o['ACC PMO']||o['acc_pmo']||'',
    // R2
    r2_toiture: o['R2_Toiture']||o['R2 Toiture']||o['r2_toiture']||'',
    r2_reseau: o['R2_Reseau']||o['R2 R√©seau']||o['r2_reseau']||'',
    r2_pdl: o['R2_PDL']||o['R2 PDL']||o['r2_pdl']||'',
    r2_ecs: o['R2_ECS']||o['R2 ECS']||o['r2_ecs']||'',
    r2_ve_modele: o['R2_VE_Modele']||o['R2 VE Mod√®le']||o['r2_ve_modele']||'',
    r2_ve_km: o['R2_VE_Km_an']||o['R2 VE Km/an']||o['r2_ve_km']||'',
    r2_ve_recharges: o['R2_VE_Recharges_sem']||o['R2 VE Recharges']||o['r2_ve_recharges']||'',
    // CR
    cr_date: o['CR_Date']||o['CR Date']||o['cr_date']||'',
    cr_duree: o['CR_Duree_min']||o['CR Dur√©e (min)']||o['cr_duree']||'',
    cr_next: o['CR_Next']||o['cr_next']||'',
    cr_notes: o['CR_Commentaires']||o['CR Commentaires']||o['cr_notes']||'',
    notes: o['Notes']||o['notes']||'',
    // photos non import√©es depuis Excel
    cr_photos: []
  };
}
function importRows(rows){
  let added=0, updated=0;
  rows.forEach(r=>{
    const p = norm(r);
    const i = DB.findIndex(x=>x.id===p.id);
    if(i>=0){ DB[i] = Object.assign(DB[i], p); updated++; } else { DB.push(p); added++; }
  });
  save(); renderList(); toast(`Import: +${added} ajout(s), ${updated} maj`);
}

$('btnExport').onclick=()=>{
  if(!DB.length){ toast('Aucune donn√©e'); return; }
  const H = ["Prospect_ID","Date_fiche","Segment","Marche","Nom","Telephone","Email","Adresse","CP","Commune","Lat","Lon","Canal","Pipeline","Relance_Date","Relance_Statut",
             "ACC_Type","ACC_Logts","ACC_Conso_MWh","ACC_Toit_m2","ACC_Contact","ACC_PMO",
             "R2_Toiture","R2_Reseau","R2_PDL","R2_ECS","R2_VE_Modele","R2_VE_Km_an","R2_VE_Recharges_sem",
             "CR_Date","CR_Duree_min","CR_Next","CR_Commentaires","Notes"];
  const rows = DB.map(p=>[
    p.id,p.date,p.segment,p.marche,p.nom,p.tel,p.email,p.adresse,p.cp,p.commune,p.lat,p.lon,p.canal,p.pipeline,p.relance_date,p.relance_statut,
    p.acc_type||'',p.acc_logts||'',p.acc_conso||'',p.acc_toit||'',p.acc_contact||'',p.acc_pmo||'',
    p.r2_toiture||'',p.r2_reseau||'',p.r2_pdl||'',p.r2_ecs||'',p.r2_ve_modele||'',p.r2_ve_km||'',p.r2_ve_recharges||'',
    p.cr_date||'',p.cr_duree||'',p.cr_next||'',p.cr_notes||'',p.notes||''
  ]);
  const ws = XLSX.utils.aoa_to_sheet([H,...rows]); const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Prospects');
  const out = XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob = new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const file = new File([blob], `Prospection_PV-${tsName()}.xlsx`, {type:blob.type});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    navigator.share({files:[file], title:'Export Prospection PV', text:'Echome Prospects'});
  }else{
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
  }
};
function tsName(){const d=new Date();const pad=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;}

// ====== Init ======
document.addEventListener('DOMContentLoaded',()=>{ renderList(); });

</script>
</body>
</html>
